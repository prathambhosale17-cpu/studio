rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

     // Rule 1a: ID Cards can be read by any authenticated user (for the public
    // download/search page), but can only be written (created, updated, deleted)
    // by their original owner.
    match /users/{userId}/idCards/{cardId} {
      allow read: if request.auth != null;
      allow write: if request.auth.uid == userId;
    }

    // Rule 1b: A user's Aadhaar verification history is private and can only be
    // accessed by that user.
    match /users/{userId}/aadhaarVerifications/{verificationId} {
        allow read, write: if request.auth.uid == userId;
    }

    // Rule 2: Rules for the ID Number lookup collection.
    match /idNumberLookups/{idNumber} {
        // Allow any authenticated user to read for search functionality.
        allow read: if request.auth != null;
        // Allow creation only if the path points to the user's own card.
        allow create: if request.auth != null
                      && request.resource.data.cardPath.matches("^users/" + request.auth.uid + "/idCards/.+$");
        // Allow deletion only if the path points to the user's own card.
        allow delete: if request.auth != null
                      && resource.data.cardPath.matches("^users/" + request.auth.uid + "/idCards/.+$");
        // Disallow updates.
        allow update: if false;
    }

    // Rule 3: Rules for the Aadhaar number lookup collection.
    match /aadhaarLookups/{aadhaarNumber} {
      // Allow any authenticated user to read for verification functionality.
      allow read: if request.auth != null;
      // Allow creation only if the path points to the user's own card.
      allow create: if request.auth != null
                    && request.resource.data.cardPath.matches("^users/" + request.auth.uid + "/idCards/.+$");
      // Allow deletion only if the path points to the user's own card.
      allow delete: if request.auth != null
                    && resource.data.cardPath.matches("^users/" + request.auth.uid + "/idCards/.+$");
      // Disallow updates.
      allow update: if false;
    }
  }
}
