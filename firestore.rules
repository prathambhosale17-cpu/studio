rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Rule 1: Users can read and write any document within their own
    // user-specific folder (e.g., /users/their-own-id/...).
    match /users/{userId}/{documents=**} {
      allow read, write: if request.auth.uid == userId;
    }

    // REMOVED: The collection group query that required this rule is no longer used.
    // The new lookup collections provide a more scalable way to find cards.
    // match /{path=**}/idCards/{cardId} {
    //   allow read: if request.auth != null;
    // }

    // Rule 2: Rules for the ID Number lookup collection.
    match /idNumberLookups/{idNumber} {
        // Allow any authenticated user to read for search functionality.
        allow read: if request.auth != null;
        // Allow creation only if the path points to the user's own card.
        allow create: if request.auth != null
                      && request.resource.data.cardPath.matches("^users/" + request.auth.uid + "/idCards/.+$");
        // Allow deletion only if the path points to the user's own card.
        allow delete: if request.auth != null
                      && resource.data.cardPath.matches("^users/" + request.auth.uid + "/idCards/.+$");
        // Disallow updates.
        allow update: if false;
    }

    // Rule 3: Rules for the Aadhaar number lookup collection.
    match /aadhaarLookups/{aadhaarNumber} {
      // Allow any authenticated user to read for verification functionality.
      allow read: if request.auth != null;
      // Allow creation only if the path points to the user's own card.
      allow create: if request.auth != null
                    && request.resource.data.cardPath.matches("^users/" + request.auth.uid + "/idCards/.+$");
      // Allow deletion only if the path points to the user's own card.
      allow delete: if request.auth != null
                    && resource.data.cardPath.matches("^users/" + request.auth.uid + "/idCards/.+$");
      // Disallow updates.
      allow update: if false;
    }
  }
}
